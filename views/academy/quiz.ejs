<%- include partials/header.ejs %>

<div class="container main-content">
<div class="row">
  <div class="col-md-12">
    <div class="jumbotron">
      <h3 class="text-light"><%=course.name%></h3>
      <h1><%=unit.name%></h1>
    </div>
    </div>
    </div>
   <div class = row>
        <div class = "col-md-12"> 

        <% var quizId = JSON.parse(quiz)._id; 
          var module = unit.modules.filter( m => m.contentId == quizId);
        %>
<div id="slickQuiz" data-module-id="<%=module[0]._id%>" data-user-id="<%=user._id%>" data-course-id="<%=course._id%>" 
  data-unit-id="<%=unit._id%>" data-quiz-json="<%=quiz%>" >
        <h1 class="quizName"><!-- where the quiz name goes --></h1>

        <div class="quizArea">
            <div class="quizHeader">
                <!-- where the quiz main copy goes -->
                <a class="button startQuiz" href="#">Get Started!</a>
            </div>

            <!-- where the quiz gets built -->
        </div>

        <div class="quizResults">
            <h3 class="quizScore">You Scored: <span><!-- where the quiz score goes --></span></h3>

            <h3 class="quizLevel"><strong>Ranking:</strong> <span><!-- where the quiz ranking level goes --></span></h3>

            <div class="quizResultsCopy">
                <!-- where the quiz result copy goes -->
            </div>
        </div>
</div>


        </div>
    </div>
    <div class="row">
      <div class="col-md-12">
      <p>
      <hr>
      <a href="/courses/<%=course._id%>/units/<%=unit._id%>" alt="back" class="btn btn-secondary"><span class="fa fa-arrow-left" aria-hidden="true"></span> Back to <%=unit.name%></a></p>

      </div>
    </div>
</div>


<%- include partials/footer.ejs %>


<!-- Modals -->

<!-- Scripts --> 
<script src = "//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>

<script src ="https://cdn.jsdelivr.net/gh/jewlofthelotus/SlickQuiz@1.5.19/js/slickQuiz.js"></script>
<script>
$(document).ready(function(){

  var quizJSON = parseQuizData($('#slickQuiz').data('quizJson'));
  $('#slickQuiz').slickQuiz({
      json:quizJSON,
      checkAnswerText: 'Next Question',
      skipStartButton: true,
      perQuestionResponseMessaging: false,
      completionResponseMessaging: true,
      scoreAsPercentage: true,
      disableRanking: true,
      scoreTemplateText: '%score',
      events: {
        onCompleteQuiz: function (options) {
          var score = parseInt(options.score);
          $('#slickQuiz').data('quizScore',score);
          var quizCompleted = false;
          if( score >= 80){
            quizCompleted = true;
          } 
            var sq=$('#slickQuiz');
            var url = "/api/progress/" + sq.data('userId') + '/courses/' + sq.data('courseId') + '/units/' + sq.data('unitId') + '/modules/' + sq.data('moduleId');
               data = {
                itemCompleted: quizCompleted,
                itemProgress: score
               };

               $.ajax({
                 type: "PUT",
                 url: url,
                 dataType: 'json',
                 async: true,
                 data: data,
                 success: function (){
                 }
               });
        }  
      }
    });
});

function parseQuizData(d){

  var info = {
    name:d.name,
    results: d.results,
    main: d.main
  }
  console.log(info);

  var questions = d.questions;

  return {info,questions}
} 

</script>
</body>
</html>
